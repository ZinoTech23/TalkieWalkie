<script>
    const peer = new Peer();
    let localStream = null;

    peer.on('open', (id) => {
        document.getElementById('my-id').innerText = id;
        console.log("My Peer ID is: " + id);
    });

    // Handle receiving a call
    peer.on('call', (call) => {
        console.log("Receiving call...");
        navigator.mediaDevices.getUserMedia({ audio: true }).then((stream) => {
            localStream = stream;
            localStream.getAudioTracks()[0].enabled = false; // Start muted
            call.answer(stream);
            
            call.on('stream', (remoteStream) => {
                playRemoteStream(remoteStream);
            });
        }).catch(err => console.error("Mic Error:", err));
    });

    // Function to play audio
    function playRemoteStream(remoteStream) {
        const audio = new Audio();
        audio.srcObject = remoteStream;
        // This hack bypasses some browser autoplay blocks
        audio.play().then(() => {
            console.log("Audio playing successfully");
        }).catch(err => console.log("Autoplay blocked. Click the page."));
    }

    // Connect to someone
    document.getElementById('call-btn').onclick = () => {
        const targetId = document.getElementById('peer-id').value;
        console.log("Attempting to connect to: " + targetId);
        
        navigator.mediaDevices.getUserMedia({ audio: true }).then((stream) => {
            localStream = stream;
            localStream.getAudioTracks()[0].enabled = false;
            const call = peer.call(targetId, stream);
            
            call.on('stream', (remoteStream) => {
                playRemoteStream(remoteStream);
            });
            document.getElementById('status').innerText = "LINK ESTABLISHED";
        });
    };

    // PTT Logic
    const pttBtn = document.getElementById('ptt-button');
    const startTalking = () => {
        if (localStream) {
            localStream.getAudioTracks()[0].enabled = true;
            document.getElementById('status').innerText = "TRANSMITTING...";
        }
    };
    const stopTalking = () => {
        if (localStream) {
            localStream.getAudioTracks()[0].enabled = false;
            document.getElementById('status').innerText = "READY";
        }
    };

    pttBtn.onmousedown = startTalking;
    pttBtn.onmouseup = stopTalking;
    pttBtn.ontouchstart = startTalking;
    pttBtn.ontouchend = stopTalking;
</script>
